# syntax=docker/dockerfile:1.7
# Simple development Dockerfile for Next.js Web App
# Focused on simplicity and avoiding permission issues

FROM oven/bun:1.2.22-alpine

# Install system dependencies
RUN apk add --no-cache libc6-compat curl bash supervisor

# Install Turbo globally
RUN bun install -g turbo@^2

# Set working directory
WORKDIR /app

# Copy workspace configuration files for dependency installation
COPY package.json bun.lock* ./
COPY turbo.json ./
COPY apps/web/package.json ./apps/web/
COPY packages/ ./packages/

# Install dependencies (this layer will be cached)
RUN --mount=type=cache,target=/root/.bun/install/cache bun install

# Copy supervisord configuration to a location outside the mount
COPY apps/web/supervisord.dev.conf /etc/supervisord.conf

# Set development environment
ENV NODE_ENV=development
ENV NEXT_TELEMETRY_DISABLED=1

# The actual source code will be mounted via docker-compose volumes
# This avoids all permission issues with bind mounts
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisord.conf"]
