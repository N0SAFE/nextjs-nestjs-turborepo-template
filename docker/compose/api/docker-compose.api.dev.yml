services:
  # Database for development
  api-db-dev:
    container_name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}-api-db-dev
    image: postgres:17-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: ${DB_DATABASE:-nestjs_api}
    volumes:
      - api_db_data_dev:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d ${DB_DATABASE:-nestjs_api}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      app_network_dev:
        aliases:
          - api-db-dev
          - database

  # NestJS API for development
  api-dev:
    container_name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}-api-dev
    build:
      context: ../../..
      dockerfile: ./docker/builder/api/Dockerfile.api.dev
      tags:
        - "${COMPOSE_PROJECT_NAME:-nextjs-nestjs}-api-dev:latest"
        - "${COMPOSE_PROJECT_NAME:-nextjs-nestjs}-api-dev:${API_VERSION:-dev}"
    depends_on:
      api-db-dev:
        condition: service_healthy
    restart: unless-stopped
    mem_limit: 6g
    memswap_limit: 6g
    ports:
      - "${API_PORT:-3005}:${API_PORT:-3005}"
      - "${DRIZZLE_STUDIO_PORT:-4983}:4983"
    develop:
      watch:
        # Restart when Docker Compose configuration changes
        - action: restart
          path: ../../..
          target: /app
          include:
            - docker/compose/api/docker-compose.api.dev.yml
            - docker/compose/docker-compose.dev.override.yaml
            - docker/compose/docker-compose.dev.yml
        # Sync+Restart when migrations change to automatically apply them
        - action: sync+restart
          path: ../../..
          target: /app
          include:
            - apps/api/src/config/drizzle/migrations/**
        # Rebuild when critical dependency or config files change
        - action: rebuild
          path: ../../..
          target: /app
          include:
            - package.json
            - bun.lock*
            - turbo.json
            - apps/api/package.json
            - apps/api/tsconfig.json
            - apps/api/tsconfig.*.json
            - apps/api/nest-cli.json
            - apps/api/drizzle.config.ts
            - docker/builder/api/Dockerfile.api.dev
            - packages/**/package.json
        # Sync source code excluding node_modules and build artifacts
        - action: sync
          path: ../../..
          target: /app
          ignore:
            # Dependencies
            - node_modules/
            - "**/node_modules/"
            - bun.lock*
            - package-lock.json
            - yarn.lock
            - pnpm-lock.yaml
            # Build outputs
            - "**/dist/"
            - "**/build/"
            - "**/.next/"
            - "**/out/"
            - "**/.output/"
            # Cache directories
            - "**/.turbo/"
            - "**/.cache/"
            - "**/.parcel-cache/"
            - "**/.vite/"
            # Logs
            - "**/*.log"
            - "**/logs/"
            # Git
            - .git/
            - .gitignore
            # Docker
            - docker/
            - Dockerfile*
            - docker-compose*.yml
            - .dockerignore
            # IDE
            - "**/.vscode/"
            - "**/.idea/"
            - "**/*.swp"
            - "**/*.swo"
            # Testing
            - "**/coverage/"
            - "**/.nyc_output/"
            # OS files
            - "**/.DS_Store"
            - "**/Thumbs.db"
    volumes:
      # Persistent caches (shared with web/doc for faster cold starts)
      - bun_cache_dev:/root/.bun/install/cache
      - turbo_cache_dev:/root/.cache/turbo
      # Persistent uploads directory for media files
      - api_uploads_dev:/app/apps/api/uploads
    environment:
      # Runtime
      - NODE_ENV=development
      
      # Database
      # Database connection using service name (DNS resolution working with Docker Engine 28.5.2)
      - DATABASE_URL=postgresql://postgres:postgres@api-db-dev:5432/${DB_DATABASE:-nestjs_api}
      
      # API Configuration
      - API_PORT=${API_PORT:-3005}
      - LOG_LEVEL=debug
      
      # URLs
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
      - APP_URL=${APP_URL:-http://web-dev:3000}
      - API_URL=http://api-dev:${API_PORT:-3005}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:3005}
      
      # Authentication
      - AUTH_SECRET=${AUTH_SECRET:-fallback-auth-secret}
      - BETTER_AUTH_SECRET=${AUTH_SECRET:-fallback-auth-secret}
      - AUTH_BASE_DOMAIN=${AUTH_BASE_DOMAIN:-http://localhost}
      - DEV_AUTH_KEY=${DEV_AUTH_KEY:-dev-fallback-key}
      # DEFAULT_ADMIN_EMAIL is used for both admin creation and master token impersonation
      - TRUSTED_ORIGINS=${TRUSTED_ORIGINS:-}
      
      # Passkey Configuration
      - PASSKEY_RPID=${PASSKEY_RPID:-localhost}
      - PASSKEY_RPNAME=${PASSKEY_RPNAME:-NestJS App}
      - PASSKEY_ORIGIN=${PASSKEY_ORIGIN:-http://localhost:3000}
      
      # Uploads directory path (absolute path in container)
      - UPLOADS_DIR=${UPLOADS_DIR:-/app/apps/api/uploads}

      # Default Admin Credentials (for seeding)
      - DEFAULT_ADMIN_EMAIL=${DEFAULT_ADMIN_EMAIL:-admin@admin.com}
      - DEFAULT_ADMIN_PASSWORD=${DEFAULT_ADMIN_PASSWORD:-adminadmin}

      # Enable seeding for mock data (development mode)
      - ENABLE_SEEDING=true
      
      # Development Tools
      - CHOKIDAR_USEPOLLING=true
      
      # Turbo Remote Cache
      - TURBO_TOKEN=${TURBO_TOKEN}
      - TURBO_TEAM=${TURBO_TEAM}
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://127.0.0.1:${API_PORT:-3005}/health || exit 1
      start_period: 15s
      interval: 15s
      timeout: 15s
      retries: 5
    networks:
      app_network_dev:
        aliases:
          - api-dev
          - api

networks:
  app_network_dev:
    name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}_app_network_dev
    driver: bridge

volumes:
  api_db_data_dev:
    name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}_api_db_data_dev
  bun_cache_dev:
    name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}_bun_cache_dev
  turbo_cache_dev:
    name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}_turbo_cache_dev
  api_uploads_dev:
    name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}_api_uploads_dev
