services:
  # Database for development
  api-db-dev:
    container_name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}-api-db-dev
    image: postgres:17-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_DB: ${DB_DATABASE:-nestjs_api}
    volumes:
      - api_db_data_dev:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-postgres} -d ${DB_DATABASE:-nestjs_api}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app_network_dev

  # NestJS API for development
  api-dev:
    container_name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}-api-dev
    build:
      context: ../../..
      dockerfile: ./docker/builder/api/Dockerfile.api.dev
      tags:
        - "${COMPOSE_PROJECT_NAME:-nextjs-nestjs}-api-dev:latest"
        - "${COMPOSE_PROJECT_NAME:-nextjs-nestjs}-api-dev:${API_VERSION:-dev}"
    depends_on:
      api-db-dev:
        condition: service_healthy
    restart: unless-stopped
    mem_limit: 2g
    memswap_limit: 2g
    ports:
      - "${API_PORT:-3005}:${API_PORT:-3005}"
      - "${DRIZZLE_STUDIO_PORT:-4983}:4983"
    develop:
      watch:
        # Restart when Docker Compose configuration changes
        - action: restart
          path: ../../..
          target: /app
          include:
            - docker/compose/api/docker-compose.api.dev.yml
            - docker/compose/docker-compose.dev.override.yaml
            - docker/compose/docker-compose.dev.yml
        # Rebuild when critical dependency or config files change
        - action: rebuild
          path: ../../..
          target: /app
          include:
            - package.json
            - bun.lock*
            - turbo.json
            - apps/api/package.json
            - apps/api/tsconfig.json
            - apps/api/tsconfig.*.json
            - apps/api/nest-cli.json
            - apps/api/drizzle.config.ts
            - docker/builder/api/Dockerfile.api.dev
            - packages/**/package.json
        # Sync source code excluding node_modules and build artifacts
        - action: sync
          path: ../../..
          target: /app
          ignore:
            # Dependencies
            - node_modules/
            - "**/node_modules/"
            - bun.lock*
            - package-lock.json
            - yarn.lock
            - pnpm-lock.yaml
            # Build outputs
            - "**/dist/"
            - "**/build/"
            - "**/.next/"
            - "**/out/"
            - "**/.output/"
            # Cache directories
            - "**/.turbo/"
            - "**/.cache/"
            - "**/.parcel-cache/"
            - "**/.vite/"
            # Logs
            - "**/*.log"
            - "**/logs/"
            # Git
            - .git/
            - .gitignore
            # Docker
            - docker/
            - Dockerfile*
            - docker-compose*.yml
            - .dockerignore
            # IDE
            - "**/.vscode/"
            - "**/.idea/"
            - "**/*.swp"
            - "**/*.swo"
            # Testing
            - "**/coverage/"
            - "**/.nyc_output/"
            # OS files
            - "**/.DS_Store"
            - "**/Thumbs.db"
    volumes:
      # Persistent caches (shared with web/doc for faster cold starts)
      - bun_cache_dev:/root/.bun/install/cache
      - turbo_cache_dev:/root/.cache/turbo
    environment:
      NODE_ENV: development
      API_PORT: ${API_PORT:-3005}
      DATABASE_URL: postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-postgres}@api-db-dev:5432/${DB_DATABASE:-nestjs_api}
      AUTH_SECRET: ${AUTH_SECRET:-fallback-auth-secret}
      JWT_SECRET: ${JWT_SECRET:-fallback-jwt-secret}
      PASSKEY_RPID: ${PASSKEY_RPID:-localhost}
      PASSKEY_RPNAME: ${PASSKEY_RPNAME:-NestJS App}
      PASSKEY_ORIGIN: ${PASSKEY_ORIGIN:-http://localhost:3000}
      REDIS_URL: redis://api-cache-dev:6379
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
      # CORS Configuration for cross-origin requests from web app
      CORS_ORIGIN: ${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
      # Development specific settings
      LOG_LEVEL: debug
      # Enable polling for file watching to avoid EBUSY errors in Docker on Windows
      CHOKIDAR_USEPOLLING: "true"
      BETTER_AUTH_URL: ${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET:-better-auth-fallback-secret}
      # Development authentication
      DEV_AUTH_KEY: ${DEV_AUTH_KEY:-dev-fallback-key}
      # Traefik Configuration
      TRAEFIK_DOMAIN: ${TRAEFIK_DOMAIN:-localhost}
      TRAEFIK_ACME_EMAIL: ${TRAEFIK_ACME_EMAIL:-admin@localhost}
      # Turbo Remote Cache Configuration
      TURBO_TOKEN: ${TURBO_TOKEN}
      TURBO_TEAM: ${TURBO_TEAM}
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://127.0.0.1:${API_PORT:-3005}/health || exit 1
      start_period: 15s
      interval: 15s
      timeout: 15s
      retries: 5
    networks:
      - app_network_dev

networks:
  app_network_dev:
    name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}_app_network_dev
    driver: bridge
    driver_opts:
      com.docker.network.bridge.host_binding_ipv4: "127.0.0.1"

volumes:
  api_db_data_dev:
    name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}_api_db_data_dev
  bun_cache_dev:
    name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}_bun_cache_dev
  turbo_cache_dev:
    name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}_turbo_cache_dev
