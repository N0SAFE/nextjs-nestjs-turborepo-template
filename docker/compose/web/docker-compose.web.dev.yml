services:
  # Next.js web app for development with HMR
  web-dev:
    container_name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}-web-dev
    build:
      context: ../../..
      dockerfile: ./docker/builder/web/Dockerfile.web.dev
      tags:
        - "${COMPOSE_PROJECT_NAME:-nextjs-nestjs}-web-dev:latest"
        - "${COMPOSE_PROJECT_NAME:-nextjs-nestjs}-web-dev:${WEB_VERSION:-dev}"
      args:
        - NODE_ENV=development
        - API_PORT=${API_PORT:-3005}
        - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
        - NEXT_PUBLIC_APP_PORT=${NEXT_PUBLIC_APP_PORT:-3000}
    restart: unless-stopped
    mem_limit: 4g
    memswap_limit: 4g
    ports:
      - "${NEXT_PUBLIC_APP_PORT:-3000}:${NEXT_PUBLIC_APP_PORT:-3000}"
    develop:
      watch:
        # Restart when Docker Compose configuration changes
        - action: restart
          path: ../../..
          target: /app
          include:
            - docker/compose/web/docker-compose.web.dev.yml
            - docker/compose/docker-compose.dev.override.yml
            - docker/compose/docker-compose.dev.yml
        # Rebuild when critical dependency or config files change
        - action: rebuild
          path: ../../..
          target: /app
          include:
            - package.json
            - bun.lock*
            - turbo.json
            - apps/web/package.json
            - apps/web/tsconfig.json
            - apps/web/tsconfig.*.json
            - apps/web/next.config.ts
            - apps/web/next.config.js
            - apps/web/next.config.mjs
            - apps/web/tailwind.config.*
            - apps/web/postcss.config.*
            - apps/web/declarative-routing.config.json
            - docker/builder/web/Dockerfile.web.dev
            - packages/**/package.json
        # Sync source code excluding node_modules and build artifacts
        - action: sync
          path: ../../..
          target: /app
          ignore:
            # Dependencies
            - node_modules/
            - "**/node_modules/"
            - bun.lock*
            - package-lock.json
            - yarn.lock
            - pnpm-lock.yaml
            # Build outputs
            - "**/dist/"
            - "**/build/"
            - "**/.next/"
            - "**/out/"
            - "**/.output/"
            # Cache directories
            - "**/.turbo/"
            - "**/.cache/"
            - "**/.parcel-cache/"
            - "**/.vite/"
            # Generated files (declarative-routing)
            - "apps/web/src/routes/index.ts"
            - "apps/web/src/routes/openapi.ts"
            # Logs
            - "**/*.log"
            - "**/logs/"
            # Git
            - .git/
            - .gitignore
            # Docker
            - docker/
            - Dockerfile*
            - docker-compose*.yml
            - .dockerignore
            # IDE
            - "**/.vscode/"
            - "**/.idea/"
            - "**/*.swp"
            - "**/*.swo"
            # Testing
            - "**/coverage/"
            - "**/.nyc_output/"
            # OS files
            - "**/.DS_Store"
            - "**/Thumbs.db"
    volumes:
      # Persistent build caches (named volumes) to speed up installs/builds
      - bun_cache_dev:/root/.bun/install/cache
      - turbo_cache_dev:/root/.cache/turbo
    environment:
      - NODE_ENV=development
      # Server-side API URL (internal Docker network)
      - API_URL=http://${COMPOSE_PROJECT_NAME:-nextjs-nestjs}-api-dev:${API_PORT:-3005}
      # Client-side API URL (localhost for browser)
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:3005}
      - API_PORT=${API_PORT:-3005}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
      - NEXT_PUBLIC_APP_PORT=${NEXT_PUBLIC_APP_PORT:-3000}
      # Auth configuration
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET:-better-auth-fallback-secret}
      - BETTER_AUTH_URL=${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
      # Development authentication
      - NEXT_PUBLIC_DEV_AUTH_KEY=${NEXT_PUBLIC_DEV_AUTH_KEY:-${DEV_AUTH_KEY:-dev-fallback-key}}
      # Docs URL (for navbar link)
      - NEXT_PUBLIC_DOC_PORT=${NEXT_PUBLIC_DOC_PORT:-3020}
      - NEXT_PUBLIC_DOC_URL=${NEXT_PUBLIC_DOC_URL:-http://localhost:${NEXT_PUBLIC_DOC_PORT:-3020}}
      # Debug configuration
      - NEXT_PUBLIC_DEBUG=${NEXT_PUBLIC_DEBUG}
      # Enable hot reloading
      - WATCHPACK_POLLING=true
      # Turbo Remote Cache Configuration
      - TURBO_TOKEN=${TURBO_TOKEN}
      - TURBO_TEAM=${TURBO_TEAM}
      - CHOKIDAR_USEPOLLING=true
      - NEXT_WEBPACK_USEPOLLING=1
    networks:
      - app_network_dev

networks:
  app_network_dev:
    name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}_app_network_dev
    driver: bridge
    driver_opts:
      com.docker.network.bridge.host_binding_ipv4: "127.0.0.1"

volumes:
  bun_cache_dev:
    name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}_bun_cache_dev
  turbo_cache_dev:
    name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}_turbo_cache_dev
