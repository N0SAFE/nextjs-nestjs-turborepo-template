name: CI/CD Pipeline

on:
    push:
        branches: [main]
    pull_request:
        # Run tests on all PRs regardless of target branch
        branches: ["**"]

env:
    BUN_VERSION: "1.3.3"
    NODE_VERSION: "22"
    TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
    TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

jobs:
    # Job 0: Setup - Install dependencies and prepare environment
    setup:
        name: ðŸ”§ Setup & Install Dependencies
        runs-on: ubuntu-latest
        timeout-minutes: 10
        outputs:
            cache-hit: ${{ steps.cache-dependencies.outputs.cache-hit }}
        steps:
            - name: ðŸ“š Checkout repository
              uses: actions/checkout@v4

            - name: ðŸ’¾ Cache Bun dependencies
              id: cache-dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.bun
                      node_modules
                      apps/**/node_modules
                      packages/**/node_modules
                      bun.lock
                  key: bun-deps-${{ runner.os }}-${{ hashFiles('**/bun.lock', '**/package.json') }}
                  restore-keys: |
                      bun-deps-${{ runner.os }}-

            - name: ðŸ° Setup Bun
              if: steps.cache-dependencies.outputs.cache-hit != 'true'
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: ${{ env.BUN_VERSION }}

            - name: ðŸ“¦ Install dependencies
              if: steps.cache-dependencies.outputs.cache-hit != 'true'
              run: |
                bun install

    # Job 1: Generate Declarative Routes
    generate-declarative-routes:
        name: ðŸ“ Generate Declarative Routes
        runs-on: ubuntu-latest
        timeout-minutes: 8
        needs: setup
        outputs:
            cache-hit: ${{ steps.cache-declarative-routes.outputs.cache-hit }}
        steps:
            - name: ðŸ“š Checkout repository
              uses: actions/checkout@v4

            - name: ðŸ’¾ Cache declarative routes
              id: cache-declarative-routes
              uses: actions/cache@v4
              with:
                  path: |
                      apps/web/src/routes/index.ts
                      apps/web/src/routes/openapi.ts
                      apps/web/openapi-docs.yml
                      apps/web/redoc-static.html
                  key: declarative-routes-${{ runner.os }}-${{ hashFiles('apps/web/src/**/page.tsx', 'apps/web/src/**/page.info.ts') }}
                  restore-keys: |
                      declarative-routes-${{ runner.os }}-

            - name: ðŸ° Setup Bun
              if: steps.cache-declarative-routes.outputs.cache-hit != 'true'
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: ${{ env.BUN_VERSION }}

            - name: ðŸ’¾ Restore Bun dependencies cache
              if: steps.cache-declarative-routes.outputs.cache-hit != 'true'
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.bun
                      node_modules
                      apps/**/node_modules
                      packages/**/node_modules
                      bun.lock
                  key: bun-deps-${{ runner.os }}-${{ hashFiles('**/bun.lock', '**/package.json') }}
                  restore-keys: |
                      bun-deps-${{ runner.os }}-

            - name: ðŸ›¤ï¸ Generate declarative routes
              if: steps.cache-declarative-routes.outputs.cache-hit != 'true'
              run: |
                bun run @repo-bin/declarative-routing build
                bun run web dr:build

            - name: ðŸ“ Generate OpenAPI documentation
              if: steps.cache-declarative-routes.outputs.cache-hit != 'true'
              run: |
                  cd apps/web
                  bun run openapi:yaml
                  bun run openapi:html

    # Job 2: Lint and Type Check
    lint-and-typecheck:
        name: ðŸ” Lint & Type Check
        runs-on: ubuntu-latest
        timeout-minutes: 8
        needs: [setup, generate-declarative-routes]
        env:
            # Turborepo configuration for --affected flag
            # Use PR target branch for pull requests, main for pushes
            TURBO_SCM_BASE: origin/${{ github.base_ref || 'main' }}
            
            # Essential environment variables for linting/type checking
            API_URL: http://localhost:8055/
            API_PORT: 8055
            API_PING_PATH: /server/health
            API_ADMIN_TOKEN: ci-test-admin-token
            NEXT_PUBLIC_APP_URL: http://localhost:3003/
            NEXT_PUBLIC_APP_PORT: 3003
            AUTH_SECRET: ci-test-auth-secret
            DIRECTUS_SECRET: ci-test-directus-secret
            DIRECTUS_ADMIN_EMAIL: ci-admin@test.com
            DIRECTUS_ADMIN_PASSWORD: ci-test-password
            NEXT_TELEMETRY_DISABLED: 1
            NODE_ENV: test
            MILLION_LINT: false
            REACT_SCAN: false
            SHOW_AUTH_LOGS: false
            NEXT_PUBLIC_SHOW_AUTH_LOGS: false

        steps:
            - name: ðŸ“š Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0  # Fetch all history for all branches and tags

            - name: ðŸ” Fetch base branch for comparison
              run: |
                  BASE_BRANCH="${{ github.base_ref || 'main' }}"
                  CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
                  
                  # Only fetch if we're not already on the base branch
                  if [ "$CURRENT_BRANCH" != "$BASE_BRANCH" ]; then
                    echo "Fetching ${BASE_BRANCH} for comparison (current: ${CURRENT_BRANCH})"
                    git fetch origin "${BASE_BRANCH}:${BASE_BRANCH}"
                  else
                    echo "Already on ${BASE_BRANCH}, skipping fetch"
                  fi

            - name: ðŸ° Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: ${{ env.BUN_VERSION }}

            - name: ðŸ’¾ Restore Bun dependencies cache
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.bun
                      node_modules
                      apps/**/node_modules
                      packages/**/node_modules
                      bun.lock
                  key: bun-deps-${{ runner.os }}-${{ hashFiles('**/bun.lock', '**/package.json') }}
                  restore-keys: |
                      bun-deps-${{ runner.os }}-

            - name: ï¿½ Restore declarative routes cache
              uses: actions/cache@v4
              with:
                  path: |
                      apps/web/src/routes/index.ts
                      apps/web/src/routes/openapi.ts
                      apps/web/openapi-docs.yml
                      apps/web/redoc-static.html
                  key: declarative-routes-${{ runner.os }}-${{ hashFiles('apps/web/src/**/page.tsx', 'apps/web/src/**/page.info.ts') }}
                  restore-keys: |
                      declarative-routes-${{ runner.os }}-

            - name: ï¿½ðŸ” Run ESLint
              run: bun x turbo run lint --affected --concurrency=75%

    # Job 3: Build
    build:
        name: ðŸ—ï¸ Build
        runs-on: ubuntu-latest
        timeout-minutes: 12
        needs: [generate-declarative-routes]
        env:
            # Turborepo configuration for --affected flag
            # Use PR target branch for pull requests, main for pushes
            TURBO_SCM_BASE: origin/${{ github.base_ref || 'main' }}
            
            # API Configuration
            API_URL: http://localhost:8055/
            API_PORT: 8055
            API_PING_PATH: /server/health
            API_ADMIN_TOKEN: ci-test-admin-token

            # App Configuration
            NEXT_PUBLIC_APP_URL: http://localhost:3003/
            NEXT_PUBLIC_APP_PORT: 3003

            # Database Configuration (for testing)
            DB_DATABASE: directus_test
            DB_ROOT_PASSWORD: test-password

            # Authentication
            AUTH_SECRET: ci-test-auth-secret-QgafJQw3O-k1gambz7YGKjtj5ZZe0dnL-WlSw4PtMDc

            # Directus Configuration
            DIRECTUS_SECRET: ci-test-directus-secret-value
            DIRECTUS_ADMIN_EMAIL: ci-admin@test.com
            DIRECTUS_ADMIN_PASSWORD: ci-test-password

            # Next.js Configuration
            NEXT_TELEMETRY_DISABLED: 1
            NODE_ENV: test

            # Development tools (disabled for CI)
            MILLION_LINT: false
            REACT_SCAN: false
            SHOW_AUTH_LOGS: false
            NEXT_PUBLIC_SHOW_AUTH_LOGS: false
            
            # Build optimization
            SKIP_STATIC_GENERATION: true

        steps:
            - name: ðŸ“š Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0  # Fetch all history for all branches and tags

            - name: ðŸ” Fetch base branch for comparison
              run: |
                  BASE_BRANCH="${{ github.base_ref || 'main' }}"
                  CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
                  
                  # Only fetch if we're not already on the base branch
                  if [ "$CURRENT_BRANCH" != "$BASE_BRANCH" ]; then
                    echo "Fetching ${BASE_BRANCH} for comparison (current: ${CURRENT_BRANCH})"
                    git fetch origin "${BASE_BRANCH}:${BASE_BRANCH}"
                  else
                    echo "Already on ${BASE_BRANCH}, skipping fetch"
                  fi

            - name: ðŸ° Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: ${{ env.BUN_VERSION }}

            - name: ðŸ’¾ Restore Bun dependencies cache
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.bun
                      node_modules
                      apps/**/node_modules
                      packages/**/node_modules
                      bun.lock
                  key: bun-deps-${{ runner.os }}-${{ hashFiles('**/bun.lock', '**/package.json') }}
                  restore-keys: |
                      bun-deps-${{ runner.os }}-

            - name: ðŸ’¾ Restore declarative routes cache
              uses: actions/cache@v4
              with:
                  path: |
                      apps/web/src/routes/index.ts
                      apps/web/src/routes/openapi.ts
                      apps/web/openapi-docs.yml
                      apps/web/redoc-static.html
                  key: declarative-routes-${{ runner.os }}-${{ hashFiles('apps/web/src/**/page.tsx', 'apps/web/src/**/page.info.ts') }}
                  restore-keys: |
                      declarative-routes-${{ runner.os }}-

            - name: ðŸ—ï¸ Build packages
              run: |
                  # Build shared packages first
                  bun x turbo run compile --affected --concurrency=75%

    # Job 4: Test
    test:
        name: ðŸ§ª Test
        runs-on: ubuntu-latest
        timeout-minutes: 12
        needs: [generate-declarative-routes]
        env:
            # Turborepo configuration for --affected flag
            # Use PR target branch for pull requests, main for pushes
            TURBO_SCM_BASE: origin/${{ github.base_ref || 'main' }}
            
            # API Configuration
            API_URL: http://localhost:8055/
            API_PORT: 8055
            API_PING_PATH: /server/health
            API_ADMIN_TOKEN: ci-test-admin-token

            # App Configuration
            NEXT_PUBLIC_APP_URL: http://localhost:3003/
            NEXT_PUBLIC_APP_PORT: 3003

            # Database Configuration (for testing)
            DB_DATABASE: directus_test
            DB_ROOT_PASSWORD: test-password

            # Authentication
            AUTH_SECRET: ci-test-auth-secret-QgafJQw3O-k1gambz7YGKjtj5ZZe0dnL-WlSw4PtMDc

            # Directus Configuration
            DIRECTUS_SECRET: ci-test-directus-secret-value
            DIRECTUS_ADMIN_EMAIL: ci-admin@test.com
            DIRECTUS_ADMIN_PASSWORD: ci-test-password

            # Next.js Configuration
            NEXT_TELEMETRY_DISABLED: 1
            NODE_ENV: test

            # Development tools (disabled for CI)
            MILLION_LINT: false
            REACT_SCAN: false
            SHOW_AUTH_LOGS: false
            NEXT_PUBLIC_SHOW_AUTH_LOGS: false
            
            # Build optimization
            SKIP_STATIC_GENERATION: true

        steps:
            - name: ðŸ“š Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0  # Fetch all history for all branches and tags

            - name: ðŸ” Fetch base branch for comparison
              run: |
                  BASE_BRANCH="${{ github.base_ref || 'main' }}"
                  CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
                  
                  # Only fetch if we're not already on the base branch
                  if [ "$CURRENT_BRANCH" != "$BASE_BRANCH" ]; then
                    echo "Fetching ${BASE_BRANCH} for comparison (current: ${CURRENT_BRANCH})"
                    git fetch origin "${BASE_BRANCH}:${BASE_BRANCH}"
                  else
                    echo "Already on ${BASE_BRANCH}, skipping fetch"
                  fi

            - name: ðŸ° Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: ${{ env.BUN_VERSION }}

            - name: ðŸ’¾ Restore Bun dependencies cache
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.bun
                      node_modules
                      apps/**/node_modules
                      packages/**/node_modules
                      bun.lock
                  key: bun-deps-${{ runner.os }}-${{ hashFiles('**/bun.lock', '**/package.json') }}
                  restore-keys: |
                      bun-deps-${{ runner.os }}-

            - name: ðŸ’¾ Restore declarative routes cache
              uses: actions/cache@v4
              with:
                  path: |
                      apps/web/src/routes/index.ts
                      apps/web/src/routes/openapi.ts
                      apps/web/openapi-docs.yml
                      apps/web/redoc-static.html
                  key: declarative-routes-${{ runner.os }}-${{ hashFiles('apps/web/src/**/page.tsx', 'apps/web/src/**/page.info.ts') }}
                  restore-keys: |
                      declarative-routes-${{ runner.os }}-

            - name: ðŸ§ª Run tests for all packages
              run: bun x turbo run test --affected --concurrency=75%

    # Job 5: Deployment Ready Check
    deployment-ready:
        name: ðŸš€ Deployment Ready
        runs-on: ubuntu-latest
        timeout-minutes: 3
        needs: [setup, generate-declarative-routes, lint-and-typecheck, build, test]
        if: always()

        steps:
            - name: âœ… Check deployment readiness
              run: |
                  echo "ðŸ” Checking CI/CD pipeline results..."

                  SETUP_STATUS="${{ needs.setup.result }}"
                  LINT_STATUS="${{ needs.lint-and-typecheck.result }}"
                  BUILD_STATUS="${{ needs.build.result }}"
                  TEST_STATUS="${{ needs.test.result }}"
                  DR_STATUS="${{ needs.generate-declarative-routes.result }}"

                  # Cache hit information
                  BUN_CACHE_HIT="${{ needs.setup.outputs.cache-hit }}"
                  DR_CACHE_HIT="${{ needs.generate-declarative-routes.outputs.cache-hit }}"

                  echo "ðŸ“‹ Pipeline Results:"
                  echo "  - Setup & Dependencies: $SETUP_STATUS"
                  echo "  - Lint & Type Check: $LINT_STATUS"
                  echo "  - Build: $BUILD_STATUS"
                  echo "  - Test: $TEST_STATUS"
                  echo "  - Declarative Routes: $DR_STATUS"
                  
                  echo ""
                  echo "ðŸŽ¯ Cache Performance:"
                  echo "  - Bun Dependencies: $([ "$BUN_CACHE_HIT" = "true" ] && echo "âœ… Cache HIT" || echo "âŒ Cache MISS")"
                  echo "  - Declarative Routes: $([ "$DR_CACHE_HIT" = "true" ] && echo "âœ… Cache HIT" || echo "âŒ Cache MISS")"

                  if [ "$SETUP_STATUS" = "success" ] && [ "$LINT_STATUS" = "success" ] && [ "$BUILD_STATUS" = "success" ] && [ "$TEST_STATUS" = "success" ] && [ "$DR_STATUS" = "success" ]; then
                    if [ "${{ github.ref }}" = "refs/heads/main" ]; then
                      echo "ðŸš€ âœ… Ready for production deployment!"
                      echo "deployment_ready=true" >> $GITHUB_OUTPUT
                    else
                      echo "ðŸš€ âœ… Ready for staging deployment!"
                      echo "deployment_ready=true" >> $GITHUB_OUTPUT
                    fi
                  else
                    echo "ðŸš€ âŒ Not ready for deployment"
                    echo "deployment_ready=false" >> $GITHUB_OUTPUT
                    exit 1
                  fi

            - name: ðŸ“‹ Generate deployment summary
              run: |
                  # Cache hit information
                  BUN_CACHE_HIT="${{ needs.setup.outputs.cache-hit }}"
                  DR_CACHE_HIT="${{ needs.generate-declarative-routes.outputs.cache-hit }}"
                  
                  echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Setup & Dependencies | ${{ needs.setup.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Lint & Type Check | ${{ needs.lint-and-typecheck.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Build | ${{ needs.build.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Test | ${{ needs.test.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Declarative Routes | ${{ needs.generate-declarative-routes.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  
                  echo "### ðŸŽ¯ Cache Performance" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Cache Type | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Bun Dependencies | $([ "$BUN_CACHE_HIT" = "true" ] && echo "âœ… HIT" || echo "âŒ MISS") |" >> $GITHUB_STEP_SUMMARY
                  echo "| Declarative Routes | $([ "$DR_CACHE_HIT" = "true" ] && echo "âœ… HIT" || echo "âŒ MISS") |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ github.ref }}" = "refs/heads/main" ]; then
                    echo "ðŸŽ¯ **Branch**: Production (main)" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "ðŸŽ¯ **Branch**: Development" >> $GITHUB_STEP_SUMMARY
                  fi
